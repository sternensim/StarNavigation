# Development compose file — optimised for fast iteration.
#
# Usage:
#   First run (builds images):   docker compose -f docker-compose.dev.yml up --build
#   Subsequent runs:             docker compose -f docker-compose.dev.yml up
#   Rebuild after dep changes:   docker compose -f docker-compose.dev.yml up --build
#
# Backend:  source is volume-mounted; uvicorn --reload restarts on every .py save.
# Frontend: Vite dev server with HMR — browser updates without a full page reload.
#           No npm install or vite build needed after the first image build.

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: navigation-backend-dev
    volumes:
      - skyfield_data:/app/skyfield_data
      - ./backend/src:/app/src          # mount source so --reload picks up changes
    environment:
      - ENV=development
    command: uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "0.0.0.0:8000:8000"            # explicit all-interface binding (required for non-localhost access)
    networks:
      - navigation-network
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: navigation-frontend-dev
    volumes:
      - ./frontend:/app                 # live source mount — Vite HMR watches this
      - /app/node_modules               # anonymous volume keeps image node_modules intact
    environment:
      - VITE_API_TARGET=http://backend:8000   # proxy target inside Docker network
      - VITE_HMR_HOST=navi.graeffcloud.de     # enable HMR from remote host
      # Set VITE_HMR_HOST to the Docker host's IP or hostname so the browser
      # connects HMR websockets to the right address when accessing remotely.
      # e.g. add  VITE_HMR_HOST=192.168.1.100  to a .env.dev file or export it
      # before running compose. Leave unset when accessing from localhost.
    ports:
      - "0.0.0.0:5173:5173"            # explicit all-interface binding
    depends_on:
      - backend
    networks:
      - navigation-network
    restart: unless-stopped

networks:
  navigation-network:
    driver: bridge

volumes:
  skyfield_data:
